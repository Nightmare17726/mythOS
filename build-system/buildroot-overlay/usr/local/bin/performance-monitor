#!/usr/bin/env python3
"""mythOS Performance Monitor (Dragon Edition)
Real-time system performance dashboard optimized for gaming"""

import sys,os,subprocess,time,psutil
try:
    import gi
    gi.require_version('Gtk','3.0')
    from gi.repository import Gtk,GLib
    HAS_GUI=True
except:
    HAS_GUI=False

class PerformanceMonitor(Gtk.Window if HAS_GUI else object):
    def __init__(self):
        if not HAS_GUI:
            self.terminal_mode()
            return

        super().__init__(title="mythOS Performance Monitor")
        self.set_default_size(900,700)
        self.set_border_width(15)

        box=Gtk.Box(orientation=Gtk.Orientation.VERTICAL,spacing=15)
        self.add(box)

        # Title
        title=Gtk.Label()
        title.set_markup('<span size="x-large" weight="bold">âš¡ Performance Monitor</span>')
        box.pack_start(title,False,False,10)

        # Metrics grid
        grid=Gtk.Grid()
        grid.set_column_spacing(20)
        grid.set_row_spacing(15)
        box.pack_start(grid,True,True,0)

        # CPU
        grid.attach(Gtk.Label(label="CPU Usage:"),0,0,1,1)
        self.cpu_bar=Gtk.ProgressBar()
        self.cpu_bar.set_show_text(True)
        grid.attach(self.cpu_bar,1,0,2,1)

        # Memory
        grid.attach(Gtk.Label(label="Memory:"),0,1,1,1)
        self.mem_bar=Gtk.ProgressBar()
        self.mem_bar.set_show_text(True)
        grid.attach(self.mem_bar,1,1,2,1)

        # FPS Counter
        grid.attach(Gtk.Label(label="Avg FPS:"),0,2,1,1)
        self.fps_label=Gtk.Label(label="--")
        grid.attach(self.fps_label,1,2,1,1)

        # Process list
        scroll=Gtk.ScrolledWindow()
        scroll.set_min_content_height(300)
        self.store=Gtk.ListStore(str,str,str,str)
        self.treeview=Gtk.TreeView(model=self.store)
        for i,title in enumerate(["PID","Name","CPU%","Memory"]):
            renderer=Gtk.CellRendererText()
            column=Gtk.TreeViewColumn(title,renderer,text=i)
            self.treeview.append_column(column)
        scroll.add(self.treeview)
        box.pack_start(scroll,True,True,0)

        # Boost button
        boost_btn=Gtk.Button(label="ðŸš€ Gaming Boost Mode")
        boost_btn.set_size_request(-1,50)
        boost_btn.connect("clicked",self.enable_boost)
        box.pack_end(boost_btn,False,False,0)

        GLib.timeout_add_seconds(1,self.update_stats)
        self.update_stats()

    def update_stats(self):
        # CPU
        cpu=psutil.cpu_percent(interval=0.1)
        self.cpu_bar.set_fraction(cpu/100)
        self.cpu_bar.set_text(f"{cpu:.1f}%")

        # Memory
        mem=psutil.virtual_memory()
        self.mem_bar.set_fraction(mem.percent/100)
        self.mem_bar.set_text(f"{mem.percent:.1f}% ({mem.used//1024//1024}MB/{mem.total//1024//1024}MB)")

        # Top processes
        self.store.clear()
        for proc in sorted(psutil.process_iter(['pid','name','cpu_percent','memory_percent']),
                          key=lambda p:p.info['cpu_percent'],reverse=True)[:10]:
            self.store.append([
                str(proc.info['pid']),
                proc.info['name'][:20],
                f"{proc.info['cpu_percent']:.1f}",
                f"{proc.info['memory_percent']:.1f}"
            ])

        return True

    def enable_boost(self,btn):
        try:
            subprocess.run(['sudo','cpufreq-set','-g','performance'])
            subprocess.run(['sudo','sysctl','vm.swappiness=10'])
            dialog=Gtk.MessageDialog(transient_for=self,flags=0,
                message_type=Gtk.MessageType.INFO,buttons=Gtk.ButtonsType.OK,
                text="Gaming Boost Enabled!")
            dialog.format_secondary_text("CPU performance maximized for gaming.")
            dialog.run()
            dialog.destroy()
        except Exception as e:
            print(f"Error: {e}")

    def terminal_mode(self):
        while True:
            os.system('clear')
            print("="*60)
            print(" mythOS Performance Monitor".center(60))
            print("="*60)
            cpu=psutil.cpu_percent()
            mem=psutil.virtual_memory()
            print(f"\nCPU:    [{'#'*int(cpu/5):<20}] {cpu:.1f}%")
            print(f"Memory: [{'#'*int(mem.percent/5):<20}] {mem.percent:.1f}%")
            print(f"\nTop Processes:")
            print(f"{'PID':<8}{'Name':<20}{'CPU%':<8}{'Mem%':<8}")
            print("-"*44)
            for p in sorted(psutil.process_iter(['pid','name','cpu_percent','memory_percent']),
                           key=lambda x:x.info['cpu_percent'],reverse=True)[:5]:
                print(f"{p.info['pid']:<8}{p.info['name'][:18]:<20}{p.info['cpu_percent']:<8.1f}{p.info['memory_percent']:<8.1f}")
            time.sleep(2)

if HAS_GUI:
    win=PerformanceMonitor()
    win.connect("destroy",Gtk.main_quit)
    win.show_all()
    Gtk.main()
else:
    PerformanceMonitor()
