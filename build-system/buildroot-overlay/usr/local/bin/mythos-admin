#!/bin/bash
# mythOS System Administration Tool
# Manages users, firewall, services, and system settings

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Check root
if [ "$EUID" -ne 0 ]; then
    echo -e "${RED}Error: This tool must be run as root${NC}"
    echo "Please run: sudo mythos-admin"
    exit 1
fi

show_menu() {
    clear
    cat << EOF
╔══════════════════════════════════════════════════════════════╗
║                                                              ║
║           mythOS System Administration                       ║
║                                                              ║
╚══════════════════════════════════════════════════════════════╝

1. User Management
2. Firewall Configuration
3. Service Management
4. System Updates
5. Storage Management
6. Exit

EOF
    read -p "Select an option [1-6]: " choice
    echo ""
}

# User Management
user_management() {
    while true; do
        clear
        echo -e "${BLUE}=== User Management ===${NC}"
        echo ""
        echo "1. List users"
        echo "2. Add user"
        echo "3. Delete user"
        echo "4. Change password"
        echo "5. Back to main menu"
        echo ""
        read -p "Select an option [1-5]: " choice

        case $choice in
            1)
                echo -e "\n${GREEN}Current users:${NC}"
                awk -F: '$3 >= 1000 {printf "  %-15s (UID: %s)\n", $1, $3}' /etc/passwd
                read -p "Press Enter to continue..."
                ;;
            2)
                read -p "Enter username: " username
                if id "$username" &>/dev/null; then
                    echo -e "${RED}User already exists${NC}"
                else
                    adduser "$username"
                    echo -e "${GREEN}User $username created successfully${NC}"
                fi
                read -p "Press Enter to continue..."
                ;;
            3)
                read -p "Enter username to delete: " username
                if id "$username" &>/dev/null; then
                    read -p "Are you sure you want to delete $username? (yes/no): " confirm
                    if [ "$confirm" = "yes" ]; then
                        deluser --remove-home "$username" 2>/dev/null || userdel -r "$username"
                        echo -e "${GREEN}User $username deleted${NC}"
                    fi
                else
                    echo -e "${RED}User does not exist${NC}"
                fi
                read -p "Press Enter to continue..."
                ;;
            4)
                read -p "Enter username: " username
                if id "$username" &>/dev/null; then
                    passwd "$username"
                else
                    echo -e "${RED}User does not exist${NC}"
                fi
                read -p "Press Enter to continue..."
                ;;
            5)
                return
                ;;
        esac
    done
}

# Firewall Configuration
firewall_management() {
    while true; do
        clear
        echo -e "${BLUE}=== Firewall Configuration ===${NC}"
        echo ""

        # Check if iptables is available
        if ! command -v iptables &> /dev/null; then
            echo -e "${RED}iptables not installed${NC}"
            read -p "Press Enter to continue..."
            return
        fi

        echo "1. Show firewall rules"
        echo "2. Enable basic firewall (allow SSH, block all other incoming)"
        echo "3. Disable firewall (allow all)"
        echo "4. Allow specific port"
        echo "5. Block specific port"
        echo "6. Back to main menu"
        echo ""
        read -p "Select an option [1-6]: " choice

        case $choice in
            1)
                echo -e "\n${GREEN}Current firewall rules:${NC}"
                iptables -L -n -v
                read -p "Press Enter to continue..."
                ;;
            2)
                # Basic firewall - allow SSH, block incoming
                iptables -F
                iptables -P INPUT DROP
                iptables -P FORWARD DROP
                iptables -P OUTPUT ACCEPT
                iptables -A INPUT -i lo -j ACCEPT
                iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
                iptables -A INPUT -p tcp --dport 22 -j ACCEPT
                iptables -A INPUT -p icmp -j ACCEPT
                echo -e "${GREEN}Basic firewall enabled (SSH allowed, other incoming blocked)${NC}"
                read -p "Press Enter to continue..."
                ;;
            3)
                # Disable firewall
                iptables -F
                iptables -P INPUT ACCEPT
                iptables -P FORWARD ACCEPT
                iptables -P OUTPUT ACCEPT
                echo -e "${YELLOW}Firewall disabled (all traffic allowed)${NC}"
                read -p "Press Enter to continue..."
                ;;
            4)
                read -p "Enter port number to allow: " port
                iptables -A INPUT -p tcp --dport "$port" -j ACCEPT
                echo -e "${GREEN}Port $port allowed${NC}"
                read -p "Press Enter to continue..."
                ;;
            5)
                read -p "Enter port number to block: " port
                iptables -A INPUT -p tcp --dport "$port" -j DROP
                echo -e "${GREEN}Port $port blocked${NC}"
                read -p "Press Enter to continue..."
                ;;
            6)
                return
                ;;
        esac
    done
}

# Service Management
service_management() {
    while true; do
        clear
        echo -e "${BLUE}=== Service Management ===${NC}"
        echo ""
        echo "1. List running services"
        echo "2. Start SSH server"
        echo "3. Stop SSH server"
        echo "4. Restart network"
        echo "5. Back to main menu"
        echo ""
        read -p "Select an option [1-5]: " choice

        case $choice in
            1)
                echo -e "\n${GREEN}Running processes:${NC}"
                ps aux | grep -E 'sshd|dhcpcd|wpa_supplicant' | grep -v grep
                read -p "Press Enter to continue..."
                ;;
            2)
                if command -v dropbear &> /dev/null; then
                    dropbear -p 22
                    echo -e "${GREEN}SSH server started (dropbear)${NC}"
                elif command -v sshd &> /dev/null; then
                    /usr/sbin/sshd
                    echo -e "${GREEN}SSH server started${NC}"
                else
                    echo -e "${RED}SSH server not installed${NC}"
                fi
                read -p "Press Enter to continue..."
                ;;
            3)
                killall dropbear sshd 2>/dev/null || true
                echo -e "${YELLOW}SSH server stopped${NC}"
                read -p "Press Enter to continue..."
                ;;
            4)
                killall dhcpcd wpa_supplicant 2>/dev/null || true
                echo -e "${GREEN}Network services restarted${NC}"
                echo "Use network-config-ui to reconfigure network"
                read -p "Press Enter to continue..."
                ;;
            5)
                return
                ;;
        esac
    done
}

# System Updates
system_updates() {
    clear
    echo -e "${BLUE}=== System Updates ===${NC}"
    echo ""
    echo -e "${YELLOW}Note: mythOS uses a read-only system partition${NC}"
    echo "To update mythOS, use the theme-selector to download a new edition"
    echo ""
    echo "Current version:"
    cat /etc/mythos-release 2>/dev/null || echo "mythOS (version unknown)"
    echo ""
    read -p "Press Enter to continue..."
}

# Storage Management
storage_management() {
    clear
    echo -e "${BLUE}=== Storage Management ===${NC}"
    echo ""
    echo -e "${GREEN}Disk Usage:${NC}"
    df -h | grep -E '^/dev|Filesystem'
    echo ""
    echo -e "${GREEN}Mounted Filesystems:${NC}"
    mount | grep '^/dev'
    echo ""
    read -p "Press Enter to continue..."
}

# Main loop
main() {
    while true; do
        show_menu

        case $choice in
            1) user_management ;;
            2) firewall_management ;;
            3) service_management ;;
            4) system_updates ;;
            5) storage_management ;;
            6) echo "Exiting..."; exit 0 ;;
            *) echo -e "${RED}Invalid option${NC}"; sleep 1 ;;
        esac
    done
}

main
