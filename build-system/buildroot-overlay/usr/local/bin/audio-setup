#!/bin/bash
# mythOS Audio Setup and Test Tool

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

print_header() {
    clear
    cat << 'EOF'
╔══════════════════════════════════════════════════════════════╗
║                                                              ║
║              mythOS Audio Setup                              ║
║                                                              ║
╚══════════════════════════════════════════════════════════════╝

EOF
}

# Detect audio hardware
detect_audio() {
    log_info "Detecting audio hardware..."
    echo ""

    if [ ! -d /proc/asound ]; then
        log_error "ALSA not available"
        return 1
    fi

    # List sound cards
    local cards=$(cat /proc/asound/cards 2>/dev/null)
    if [ -z "$cards" ]; then
        log_error "No sound cards detected"
        echo "Possible reasons:"
        echo "  - No audio hardware present"
        echo "  - Audio drivers not loaded"
        echo "  - Audio device not configured in kernel"
        return 1
    fi

    log_success "Audio hardware detected:"
    echo "$cards"
    echo ""

    return 0
}

# Test audio output
test_audio() {
    log_info "Testing audio output..."
    echo ""

    if ! command -v speaker-test &> /dev/null; then
        log_error "speaker-test not available"
        log_info "Install alsa-utils package"
        return 1
    fi

    echo "You should hear a test tone (5 seconds)..."
    echo "Press Ctrl+C to stop early"
    echo ""

    speaker-test -t sine -f 1000 -l 1 -c 2 2>/dev/null || {
        log_error "Audio test failed"
        return 1
    }

    echo ""
    read -p "Did you hear the test tone? (y/n): " heard

    if [ "$heard" = "y" ] || [ "$heard" = "Y" ]; then
        log_success "Audio is working!"
        return 0
    else
        log_error "Audio output not working"
        echo ""
        echo "Troubleshooting:"
        echo "  1. Check volume: alsamixer"
        echo "  2. Unmute channels: amixer sset Master unmute"
        echo "  3. Increase volume: amixer sset Master 80%"
        return 1
    fi
}

# Set volume
set_volume() {
    local volume="$1"

    if ! command -v amixer &> /dev/null; then
        log_error "amixer not available"
        return 1
    fi

    amixer sset Master "${volume}%" &>/dev/null || true
    amixer sset PCM "${volume}%" &>/dev/null || true
    amixer sset Speaker "${volume}%" &>/dev/null || true
    amixer sset Headphone "${volume}%" &>/dev/null || true

    log_success "Volume set to ${volume}%"
}

# Unmute all channels
unmute_audio() {
    log_info "Unmuting audio channels..."

    if ! command -v amixer &> /dev/null; then
        log_error "amixer not available"
        return 1
    fi

    amixer sset Master unmute &>/dev/null || true
    amixer sset PCM unmute &>/dev/null || true
    amixer sset Speaker unmute &>/dev/null || true
    amixer sset Headphone unmute &>/dev/null || true

    log_success "Audio channels unmuted"
}

# Interactive mixer
launch_mixer() {
    if command -v alsamixer &> /dev/null; then
        log_info "Launching alsamixer..."
        echo "Use arrow keys to adjust volume, M to mute/unmute, Esc to exit"
        sleep 2
        alsamixer
    else
        log_error "alsamixer not available"
        return 1
    fi
}

# Main menu
main_menu() {
    while true; do
        print_header

        echo "1. Detect audio hardware"
        echo "2. Test audio output"
        echo "3. Unmute all channels"
        echo "4. Set volume to 50%"
        echo "5. Set volume to 80%"
        echo "6. Set volume to 100%"
        echo "7. Launch alsamixer (advanced)"
        echo "8. Exit"
        echo ""
        read -p "Select an option [1-8]: " choice
        echo ""

        case $choice in
            1) detect_audio; read -p "Press Enter to continue..." ;;
            2) test_audio; read -p "Press Enter to continue..." ;;
            3) unmute_audio; read -p "Press Enter to continue..." ;;
            4) set_volume 50; read -p "Press Enter to continue..." ;;
            5) set_volume 80; read -p "Press Enter to continue..." ;;
            6) set_volume 100; read -p "Press Enter to continue..." ;;
            7) launch_mixer ;;
            8) log_info "Exiting..."; exit 0 ;;
            *) log_error "Invalid option"; sleep 1 ;;
        esac
    done
}

# Quick setup mode (non-interactive)
quick_setup() {
    print_header
    log_info "Running quick audio setup..."
    echo ""

    detect_audio || exit 1
    unmute_audio
    set_volume 80

    echo ""
    test_audio

    echo ""
    log_success "Audio setup complete!"
}

# Main
if [ "${1:-}" = "--quick" ]; then
    quick_setup
else
    main_menu
fi
