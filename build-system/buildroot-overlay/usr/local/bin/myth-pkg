#!/bin/bash
# myth-pkg: mythOS Package Manager
# Lightweight package management for mythOS

set -e

VERSION="1.0.0"
REPO_URL="https://github.com/Nightmare17726/mythOS/releases/download"
CACHE_DIR="/var/cache/myth-pkg"
INSTALLED_DB="/var/lib/myth-pkg/installed.db"
AVAILABLE_DB="/var/lib/myth-pkg/available.db"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }

# Check root
require_root() {
    if [ "$EUID" -ne 0 ]; then
        log_error "This operation requires root privileges"
        echo "Run: sudo myth-pkg $@"
        exit 1
    fi
}

# Initialize package manager
init_myth_pkg() {
    mkdir -p "$CACHE_DIR" "$(dirname "$INSTALLED_DB")" "$(dirname "$AVAILABLE_DB")"

    if [ ! -f "$INSTALLED_DB" ]; then
        touch "$INSTALLED_DB"
    fi
}

# Update package database
update_database() {
    require_root "$@"
    log_info "Updating package database..."

    # Download available packages list from GitHub releases
    local latest_release="${REPO_URL}/latest/packages.list"

    if wget -q -O "${AVAILABLE_DB}.tmp" "$latest_release" 2>/dev/null; then
        mv "${AVAILABLE_DB}.tmp" "$AVAILABLE_DB"
        log_success "Package database updated"
    else
        log_warn "Could not update package database (using cached version)"
        if [ ! -f "$AVAILABLE_DB" ]; then
            # Create default package list
            cat > "$AVAILABLE_DB" << 'EOF'
# mythOS Available Packages
# Format: package_name|version|size|description|url

firefox|latest|50M|Firefox web browser|https://example.com/firefox.tar.gz
gimp|latest|30M|Image editor|https://example.com/gimp.tar.gz
libreoffice|latest|100M|Office suite|https://example.com/libreoffice.tar.gz
vlc|latest|25M|Video player|https://example.com/vlc.tar.gz
python3-dev|latest|15M|Python development tools|https://example.com/python3-dev.tar.gz
EOF
            log_info "Created default package list"
        fi
    fi
}

# List installed packages
list_installed() {
    if [ ! -f "$INSTALLED_DB" ] || [ ! -s "$INSTALLED_DB" ]; then
        log_info "No packages installed yet"
        return
    fi

    echo -e "${GREEN}Installed packages:${NC}"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    printf "%-20s %-15s %-10s %s\n" "PACKAGE" "VERSION" "SIZE" "INSTALLED"

    while IFS='|' read -r name version size date; do
        printf "%-20s %-15s %-10s %s\n" "$name" "$version" "$size" "$date"
    done < "$INSTALLED_DB"
}

# Search available packages
search_packages() {
    local query="$1"

    if [ ! -f "$AVAILABLE_DB" ]; then
        log_warn "Package database not found. Run: myth-pkg update"
        return 1
    fi

    echo -e "${GREEN}Available packages matching '$query':${NC}"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    printf "%-20s %-15s %-10s %s\n" "PACKAGE" "VERSION" "SIZE" "DESCRIPTION"

    grep -i "$query" "$AVAILABLE_DB" | grep -v '^#' | while IFS='|' read -r name version size desc url; do
        printf "%-20s %-15s %-10s %s\n" "$name" "$version" "$size" "$desc"
    done
}

# Install package
install_package() {
    require_root "$@"
    local package="$1"

    if [ -z "$package" ]; then
        log_error "No package specified"
        echo "Usage: myth-pkg install <package-name>"
        return 1
    fi

    # Check if already installed
    if grep -q "^${package}|" "$INSTALLED_DB" 2>/dev/null; then
        log_warn "Package '$package' is already installed"
        read -p "Reinstall? (y/N): " confirm
        [[ ! $confirm =~ ^[Yy]$ ]] && return 0
    fi

    # Find package in available database
    local pkg_info=$(grep "^${package}|" "$AVAILABLE_DB" 2>/dev/null)

    if [ -z "$pkg_info" ]; then
        log_error "Package '$package' not found"
        echo "Search for packages with: myth-pkg search <query>"
        return 1
    fi

    IFS='|' read -r name version size desc url <<< "$pkg_info"

    log_info "Installing $name ($version, $size)..."

    # Download package
    local pkg_file="${CACHE_DIR}/${name}-${version}.tar.gz"

    if [ ! -f "$pkg_file" ]; then
        log_info "Downloading $name..."
        if ! wget -q --show-progress -O "$pkg_file" "$url"; then
            log_error "Failed to download package"
            rm -f "$pkg_file"
            return 1
        fi
    else
        log_info "Using cached package"
    fi

    # Extract to /opt/mythOS-packages
    local install_dir="/opt/mythOS-packages/$name"
    mkdir -p "$install_dir"

    log_info "Extracting package..."
    if tar -xzf "$pkg_file" -C "$install_dir"; then
        # Run post-install script if exists
        if [ -f "$install_dir/post-install.sh" ]; then
            log_info "Running post-install script..."
            bash "$install_dir/post-install.sh"
        fi

        # Add to installed database
        echo "${name}|${version}|${size}|$(date +%Y-%m-%d)" >> "$INSTALLED_DB"

        log_success "Package '$name' installed successfully"
        log_info "Installed to: $install_dir"
    else
        log_error "Failed to extract package"
        rm -rf "$install_dir"
        return 1
    fi
}

# Remove package
remove_package() {
    require_root "$@"
    local package="$1"

    if [ -z "$package" ]; then
        log_error "No package specified"
        echo "Usage: myth-pkg remove <package-name>"
        return 1
    fi

    # Check if installed
    if ! grep -q "^${package}|" "$INSTALLED_DB" 2>/dev/null; then
        log_error "Package '$package' is not installed"
        return 1
    fi

    read -p "Remove package '$package'? (y/N): " confirm
    [[ ! $confirm =~ ^[Yy]$ ]] && return 0

    # Run pre-remove script if exists
    local install_dir="/opt/mythOS-packages/$package"
    if [ -f "$install_dir/pre-remove.sh" ]; then
        log_info "Running pre-remove script..."
        bash "$install_dir/pre-remove.sh"
    fi

    # Remove package directory
    log_info "Removing $package..."
    rm -rf "$install_dir"

    # Remove from database
    sed -i "/^${package}|/d" "$INSTALLED_DB"

    log_success "Package '$package' removed successfully"
}

# Show package info
show_package_info() {
    local package="$1"

    if [ -z "$package" ]; then
        log_error "No package specified"
        echo "Usage: myth-pkg info <package-name>"
        return 1
    fi

    # Check installed first
    local pkg_info=$(grep "^${package}|" "$INSTALLED_DB" 2>/dev/null)
    local installed=false

    if [ -n "$pkg_info" ]; then
        installed=true
        IFS='|' read -r name version size date <<< "$pkg_info"
    else
        # Check available
        pkg_info=$(grep "^${package}|" "$AVAILABLE_DB" 2>/dev/null)
        if [ -n "$pkg_info" ]; then
            IFS='|' read -r name version size desc url <<< "$pkg_info"
        else
            log_error "Package '$package' not found"
            return 1
        fi
    fi

    echo -e "${GREEN}Package Information:${NC}"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "Name:        $name"
    echo "Version:     $version"
    echo "Size:        $size"

    if [ "$installed" = true ]; then
        echo "Status:      ${GREEN}Installed${NC}"
        echo "Install Date: $date"
        echo "Location:    /opt/mythOS-packages/$name"
    else
        echo "Status:      ${YELLOW}Not installed${NC}"
        echo "Description: $desc"
    fi
}

# Clean cache
clean_cache() {
    require_root "$@"

    local cache_size=$(du -sh "$CACHE_DIR" 2>/dev/null | cut -f1)

    read -p "Remove cached packages ($cache_size)? (y/N): " confirm
    [[ ! $confirm =~ ^[Yy]$ ]] && return 0

    rm -rf "${CACHE_DIR:?}"/*
    log_success "Cache cleaned"
}

# Show help
show_help() {
    cat << EOF
myth-pkg - mythOS Package Manager v${VERSION}

Usage: myth-pkg [command] [options]

Commands:
    update              Update package database
    install <package>   Install a package
    remove <package>    Remove a package
    list                List installed packages
    search <query>      Search available packages
    info <package>      Show package information
    clean               Clean download cache
    help                Show this help message

Examples:
    myth-pkg update
    myth-pkg search firefox
    myth-pkg install firefox
    myth-pkg list
    myth-pkg remove firefox

Package Database:
    Installed: $INSTALLED_DB
    Available: $AVAILABLE_DB
    Cache:     $CACHE_DIR

For more information: https://github.com/Nightmare17726/mythOS
EOF
}

# Main
init_myth_pkg

case "${1:-help}" in
    update)
        update_database "$@"
        ;;
    install|add)
        install_package "$2"
        ;;
    remove|uninstall|rm)
        remove_package "$2"
        ;;
    list|ls)
        list_installed
        ;;
    search|find)
        search_packages "${2:-.}"
        ;;
    info|show)
        show_package_info "$2"
        ;;
    clean)
        clean_cache "$@"
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        log_error "Unknown command: $1"
        echo "Run 'myth-pkg help' for usage information"
        exit 1
        ;;
esac
