#!/bin/bash
# myth-settings: mythOS Persistent Settings Manager
# Manages system and user settings across reboots

set -e

# Settings files
SYSTEM_SETTINGS="/etc/mythos/settings.conf"
USER_SETTINGS="$HOME/.mythos/settings.conf"
SYSTEM_STATE="/var/lib/mythos/state.conf"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

# Initialize settings
init_settings() {
    # Create directories
    mkdir -p "$(dirname "$SYSTEM_SETTINGS")" "$(dirname "$USER_SETTINGS")" "$(dirname "$SYSTEM_STATE")"

    # Create default system settings if not exists
    if [ ! -f "$SYSTEM_SETTINGS" ]; then
        cat > "$SYSTEM_SETTINGS" << 'EOF'
# mythOS System Settings
# Automatically managed - edit with myth-settings command

[system]
edition=chase
version=1.0.0
first_boot=true
installer_completed=false

[display]
theme=default
language=en
timezone=UTC

[network]
wifi_enabled=true
auto_connect=true
hostname=mythos-device

[audio]
volume=80
muted=false

[power]
battery_monitor=true
low_battery_action=notify
suspend_on_idle=false

[security]
firewall_enabled=true
ssh_enabled=false
auto_updates=false
EOF
        chmod 644 "$SYSTEM_SETTINGS"
    fi

    # Create default user settings if not exists
    if [ ! -f "$USER_SETTINGS" ]; then
        cat > "$USER_SETTINGS" << 'EOF'
# mythOS User Settings

[ui]
touch_mode=auto
font_size=normal
animations=true
show_welcome=true

[apps]
default_browser=firefox
default_editor=nano
default_terminal=xterm

[preferences]
auto_save=true
confirm_delete=true
show_hidden_files=false
EOF
        chmod 644 "$USER_SETTINGS"
    fi
}

# Get setting value
get_setting() {
    local file="$1"
    local section="$2"
    local key="$3"

    [ ! -f "$file" ] && return 1

    # Parse INI file
    local in_section=false
    while IFS= read -r line; do
        # Strip comments and whitespace
        line=$(echo "$line" | sed 's/#.*//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')

        # Check for section
        if [[ $line =~ ^\[(.+)\]$ ]]; then
            if [ "${BASH_REMATCH[1]}" = "$section" ]; then
                in_section=true
            else
                in_section=false
            fi
        elif $in_section && [[ $line =~ ^([^=]+)=(.*)$ ]]; then
            if [ "${BASH_REMATCH[1]}" = "$key" ]; then
                echo "${BASH_REMATCH[2]}"
                return 0
            fi
        fi
    done < "$file"

    return 1
}

# Set setting value
set_setting() {
    local file="$1"
    local section="$2"
    local key="$3"
    local value="$4"

    [ ! -f "$file" ] && return 1

    # Create temp file
    local tmpfile=$(mktemp)

    local in_section=false
    local found=false

    while IFS= read -r line; do
        # Check for section
        if [[ $line =~ ^\[(.+)\]$ ]]; then
            # If we were in the section and didn't find the key, add it
            if $in_section && ! $found; then
                echo "${key}=${value}" >> "$tmpfile"
                found=true
            fi

            if [ "${BASH_REMATCH[1]}" = "$section" ]; then
                in_section=true
            else
                in_section=false
            fi
            echo "$line" >> "$tmpfile"
        elif $in_section && [[ $line =~ ^([^=]+)= ]]; then
            if [ "${BASH_REMATCH[1]}" = "$key" ]; then
                echo "${key}=${value}" >> "$tmpfile"
                found=true
            else
                echo "$line" >> "$tmpfile"
            fi
        else
            echo "$line" >> "$tmpfile"
        fi
    done < "$file"

    # If still not found and we were in section, add at end
    if $in_section && ! $found; then
        echo "${key}=${value}" >> "$tmpfile"
    fi

    mv "$tmpfile" "$file"
}

# Get system setting
get_sys() {
    get_setting "$SYSTEM_SETTINGS" "$1" "$2"
}

# Set system setting
set_sys() {
    if [ "$EUID" -ne 0 ]; then
        log_error "System settings require root privileges"
        echo "Run: sudo myth-settings set-sys $@"
        return 1
    fi
    set_setting "$SYSTEM_SETTINGS" "$1" "$2" "$3"
}

# Get user setting
get_user() {
    get_setting "$USER_SETTINGS" "$1" "$2"
}

# Set user setting
set_user() {
    set_setting "$USER_SETTINGS" "$1" "$2" "$3"
}

# List all settings
list_settings() {
    local scope="${1:-all}"

    if [ "$scope" = "all" ] || [ "$scope" = "system" ]; then
        echo -e "${GREEN}System Settings:${NC}"
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        cat "$SYSTEM_SETTINGS" | grep -v '^#' | grep -v '^$'
        echo ""
    fi

    if [ "$scope" = "all" ] || [ "$scope" = "user" ]; then
        echo -e "${GREEN}User Settings:${NC}"
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        cat "$USER_SETTINGS" | grep -v '^#' | grep -v '^$'
        echo ""
    fi
}

# Reset settings to defaults
reset_settings() {
    local scope="$1"

    read -p "Reset $scope settings to defaults? (y/N): " confirm
    [[ ! $confirm =~ ^[Yy]$ ]] && return 0

    if [ "$scope" = "system" ]; then
        if [ "$EUID" -ne 0 ]; then
            log_error "Resetting system settings requires root privileges"
            return 1
        fi
        rm -f "$SYSTEM_SETTINGS"
        init_settings
        log_success "System settings reset to defaults"
    elif [ "$scope" = "user" ]; then
        rm -f "$USER_SETTINGS"
        init_settings
        log_success "User settings reset to defaults"
    else
        log_error "Unknown scope: $scope"
        echo "Use: system or user"
        return 1
    fi
}

# Export settings
export_settings() {
    local output="${1:-mythos-settings-backup.tar.gz}"

    tar -czf "$output" -C / \
        "etc/mythos/settings.conf" \
        ".mythos/settings.conf" \
        2>/dev/null || true

    if [ -f "$output" ]; then
        log_success "Settings exported to: $output"
    else
        log_error "Failed to export settings"
        return 1
    fi
}

# Import settings
import_settings() {
    local input="$1"

    if [ ! -f "$input" ]; then
        log_error "File not found: $input"
        return 1
    fi

    read -p "Import settings from $input? This will overwrite current settings. (y/N): " confirm
    [[ ! $confirm =~ ^[Yy]$ ]] && return 0

    if tar -xzf "$input" -C / 2>/dev/null; then
        log_success "Settings imported successfully"
    else
        log_error "Failed to import settings"
        return 1
    fi
}

# Show help
show_help() {
    cat << EOF
myth-settings - mythOS Persistent Settings Manager

Usage: myth-settings [command] [options]

Commands:
    get-sys <section> <key>              Get system setting
    set-sys <section> <key> <value>      Set system setting (requires root)
    get-user <section> <key>             Get user setting
    set-user <section> <key> <value>     Set user setting
    list [system|user|all]               List settings
    reset <system|user>                  Reset settings to defaults
    export [file]                        Export settings backup
    import <file>                        Import settings backup
    help                                 Show this help

Examples:
    # Get system settings
    myth-settings get-sys display language
    myth-settings get-sys network hostname

    # Set system settings
    sudo myth-settings set-sys display language es
    sudo myth-settings set-sys audio volume 100

    # User settings
    myth-settings get-user ui font_size
    myth-settings set-user ui touch_mode true

    # List all settings
    myth-settings list

    # Backup and restore
    myth-settings export my-backup.tar.gz
    myth-settings import my-backup.tar.gz

Settings Files:
    System: $SYSTEM_SETTINGS
    User:   $USER_SETTINGS

Note: System settings require root privileges to modify.
EOF
}

# Main
init_settings

case "${1:-help}" in
    get-sys)
        get_sys "$2" "$3"
        ;;
    set-sys)
        set_sys "$2" "$3" "$4"
        ;;
    get-user)
        get_user "$2" "$3"
        ;;
    set-user)
        set_user "$2" "$3" "$4"
        ;;
    list|ls)
        list_settings "$2"
        ;;
    reset)
        reset_settings "$2"
        ;;
    export|backup)
        export_settings "$2"
        ;;
    import|restore)
        import_settings "$2"
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        log_error "Unknown command: $1"
        echo "Run 'myth-settings help' for usage information"
        exit 1
        ;;
esac
